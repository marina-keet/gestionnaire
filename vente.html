<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vente</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="produits.html">Produits</a>
        <a href="suivi_ventes.html">Suivi des ventes</a>
        <a href="gestion_stock.html">Gestion de stock</a>
        <a href="gestion_clients.html">Gestion de clients</a>
        <a href="tableau_bord.html">Tableau de bord</a>
        <a href="vente.html">Vente</a>
    </nav>

    <div class="container">
        <h1>Vente</h1>
        <form id="sales-form" onsubmit="addToTable(event)">
            <label for="product-name">Article :</label>
            <input type="text" id="product-name" placeholder="Article" required>

            <label for="product-price">Prix (en $) :</label>
            <input type="number" id="product-price" placeholder="Prix" required>

            <label for="product-quantity">Quantité :</label>
            <input type="number" id="product-quantity" placeholder="Quantité" required>

            <div class="form-buttons">
                <button type="submit">Ajouter au panier</button>
            </div>
        </form>

        <div style="margin-top: 2rem;">
            <h2>Produits achetés</h2>
            <table>
                <thead>
                    <tr>
                        <th>Article</th>
                        <th>Prix unitaire ($)</th>
                        <th>Quantité</th>
                        <th>Total ($)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sales-table-body">
                    <!-- Les produits ajoutés apparaîtront ici -->
                </tbody>
            </table>
            <p><strong>Total général :</strong> <span id="grand-total">0.00</span> $</p>
            <label for="discount">Réduction (%) :</label>
            <input type="number" id="discount" placeholder="0" min="0" max="100" onchange="applyDiscount()">
            <p><strong>Total après réduction :</strong> <span id="discounted-total">0.00</span> $</p>
            <label for="client-name">Nom du client :</label>
            <input type="text" id="client-name" placeholder="Nom du client">
            <button onclick="printInvoice()">Imprimer la facture</button>
        </div>

        <!-- Section Facture -->
        <div id="invoice" style="display: none;">
            <h2>Facture</h2>
            <p><strong>Nom du client :</strong> <span id="invoice-client-name"></span></p>
            <div id="invoice-details">
                <!-- Les informations de la facture seront générées ici -->
            </div>
            <p><strong>Total général :</strong> <span id="invoice-grand-total"></span> $</p>
        </div>
    </div>

    <script>
        const salesTableBody = document.getElementById('sales-table-body');
        const grandTotalElement = document.getElementById('grand-total');
        const discountedTotalElement = document.getElementById('discounted-total');
        const invoiceDetails = document.getElementById('invoice-details');
        const invoiceGrandTotal = document.getElementById('invoice-grand-total');
        const clientNameInput = document.getElementById('client-name');
        const invoiceClientName = document.getElementById('invoice-client-name');

        function addToTable(event) {
            event.preventDefault();

            // Récupérer les valeurs du formulaire
            const productName = document.getElementById('product-name').value;
            const productPrice = parseFloat(document.getElementById('product-price').value);
            const productQuantity = parseInt(document.getElementById('product-quantity').value);

            // Calculer le total pour cet article
            const total = productPrice * productQuantity;

            // Ajouter une nouvelle ligne au tableau
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${productName}</td>
                <td>${productPrice.toFixed(2)}</td>
                <td><input type="number" value="${productQuantity}" min="1" onchange="updateRowTotal(this)"></td>
                <td class="row-total">${total.toFixed(2)}</td>
                <td><button onclick="removeRow(this)">Supprimer</button></td>
            `;
            salesTableBody.appendChild(row);

            // Mettre à jour le total général
            updateGrandTotal();

            // Réinitialiser le formulaire
            document.getElementById('sales-form').reset();
        }

        function updateRowTotal(input) {
            const row = input.closest('tr');
            const price = parseFloat(row.children[1].textContent);
            const quantity = parseInt(input.value);
            const totalCell = row.children[3];

            // Mettre à jour le total pour cette ligne
            const total = price * quantity;
            totalCell.textContent = total.toFixed(2);

            // Mettre à jour le total général
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let grandTotal = 0;
            const rows = salesTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const rowTotal = parseFloat(row.children[3].textContent);
                grandTotal += rowTotal;
            });
            grandTotalElement.textContent = grandTotal.toFixed(2);

            // Appliquer la réduction si elle est définie
            applyDiscount();
        }

        function applyDiscount() {
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = parseFloat(grandTotalElement.textContent);

            // Calculer le total après réduction
            const discountedTotal = grandTotal - (grandTotal * discount / 100);
            discountedTotalElement.textContent = discountedTotal.toFixed(2);
        }

        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();

            // Mettre à jour le total général
            updateGrandTotal();
        }

        function printInvoice() {
            // Récupérer le nom du client
            const clientName = clientNameInput.value;
            invoiceClientName.textContent = clientName || "Non spécifié";

            // Générer les informations de la facture
            invoiceDetails.innerHTML = '';
            const rows = salesTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const productName = row.children[0].textContent;
                const productPrice = row.children[1].textContent;
                const productQuantity = row.children[2].querySelector('input').value;
                const productTotal = row.children[3].textContent;

                const detail = document.createElement('div');
                detail.style.display = 'flex';
                detail.style.flexDirection = 'column';
                detail.style.marginBottom = '0.5rem';
                detail.innerHTML = `
                    <p><strong>Article :</strong> ${productName}</p>
                    <p><strong>Prix unitaire :</strong> ${productPrice} $</p>
                    <p><strong>Quantité :</strong> ${productQuantity}</p>
                    <p><strong>Total :</strong> ${productTotal} $</p>
                `;
                invoiceDetails.appendChild(detail);
            });

            // Mettre à jour le total général dans la facture
            invoiceGrandTotal.textContent = discountedTotalElement.textContent;

            // Afficher uniquement la facture pour l'impression
            const printContent = document.getElementById('invoice').innerHTML;
            const originalContent = document.body.innerHTML;

            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            window.location.reload();
        }
    </script>
</body>
</html>
